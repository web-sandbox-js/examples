(function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):(a="undefined"==typeof globalThis?a||self:globalThis,a.HTMLWebWidgetElement=b())})(this,function(){'use strict';function a(a,b,c={}){const{define:d,module:e,exports:f}=F(()=>{const a={},b={exports:a};return{module:b,exports:a,define:a=>{b.exports="function"==typeof a?a():a}}},b)();return d.amd=!0,F(a,b,{define:d,module:e,exports:f,...c}),e.exports}function b(a,b){return"object"!=typeof b&&(b=new Error(b)),b.message=`WebWidget<${a.name}> Error: ${b.message}`,b}function c(a){const c=a.name;let d="function"==typeof a.properties?a.properties(c):a.properties;("object"!=typeof d||null===d||Array.isArray(d))&&(d={});const e={unmount(){return a.view.unmount()}},f={get context(){return e},get name(){return a.name},get container(){return a.container},get sandboxed(){return!!a.sandbox},customPortals:{get(){return a.customPortals.get(...arguments)},define(){return a.customPortals.define(...arguments)}},createPortal(c,d){let e;const f=K(a,d);if(f&&(e=f()),!e)throw b(a,new Error(`The portal cannot be found: ${d}`));if(!(e instanceof HTMLWebWidgetElement))throw b(a,new Error(`Portal must be an instance of "HTMLWebWidgetElement": ${d}`));a.sandbox&&!c.isConnected&&a.container.appendChild(c),c.slot||(c.slot="");const g=e.querySelector(`[slot="${c.slot}"]`);g&&e.removeChild(g),e.appendChild(c);const h=e.constructor.MODEL,i=e.mount();return a.portals.push(e[h]),{async mount(){return await i,e.mount()},async unmount(){return await i,e.unmount()}}},...d};return a.sandbox?a.sandbox.toVirtual(f):f}function d(a){return a&&"function"==typeof a.then&&"function"==typeof a.catch}function e(a,c,e){let f=c[e]||(async()=>{});return f=Array.isArray(f)?f:[f],0===f.length&&(f=[()=>Promise.resolve()]),function(c){return f.reduce((e,f,g)=>e.then(()=>{const e=f(c);return d(e)?e:Promise.reject(b(a,new Error(`The lifecycle function at array index ${g} did not return a promise`)))}),Promise.resolve())}}function f(a,d){return new Promise((e,f)=>{function g(c){if(!k)if(!0===c)l=!0,h.dieOnTimeout?f(b(a,new Error(j))):console.error(b(a,new Error(j)));else if(!l){const d=c;console.warn(b(a,new Error(j))),d*i+i<h.millis&&setTimeout(()=>g(d+1),i)}}const h=a.timeouts[d],i=h.warningMillis,j=`Lifecycle function ${d} for ${a.name} lifecycle did not resolve or reject for ${h.millis} ms.`;let k=!1,l=!1;a[d](c(a)).then(a=>{k=!0,e(a)}).catch(a=>{k=!0,f(a)}),setTimeout(()=>g(1),i),setTimeout(()=>g(!0),h.millis)})}function g(a){const b={};for(const c in M)b[c]={...M[c],...(a&&a[c]||{})};return b}async function h(a){return a.bootstrapPromise?a.bootstrapPromise:a.status===q?(a.status=r,a.bootstrapPromise=f(a,"bootstrap").then(()=>{a.status=s}).catch(c=>{throw a.status=y,a.bootstrapPromise=null,b(a,c)}),a.bootstrapPromise):void 0}async function i(a){return a.loadPromise?a.loadPromise:a.status===o||a.status===x?(a.status=p,a.loadPromise=a.loader(c(a)).then((b={})=>{Object.assign(a,{bootstrap:e(a,b,"bootstrap"),mount:e(a,b,"mount"),status:q,timeouts:g(b.timeouts),unload:e(a,b,"unload"),unmount:e(a,b,"unmount"),update:e(a,b,"update")})}).catch(c=>{throw a.status=x,a.loadPromise=null,b(a,c)}),a.loadPromise):void 0}async function j(a){if(a.unmountPromise)return a.unmountPromise;if(a.status!==t)return;a.status=v;const c=a.children,d=c.map(async a=>j(a).catch(b=>(a.status=D,void console.warn(b))));return a.unmountPromise=Promise.all(d).then(()=>f(a,"unmount").then(()=>{a.status=s,a.mountPromise=null}).catch(c=>{throw a.status=B,a.unmountPromise=null,b(a,c)})),a.unmountPromise}async function k(a){return a.mountPromise?a.mountPromise:a.status===s?(a.mountPromise=f(a,"mount").then(()=>{a.status=t,a.unmountPromise=null}).catch(async c=>{throw a.status=t,await j(a),a.status=z,a.mountPromise=null,b(a,c)}),a.mountPromise):void 0}function l(a){Object.assign(a,{bootstrap:null,mount:null,status:o,timeouts:null,unload:null,unmount:null,update:null})}async function m(a){return a.unloadPromise?a.unloadPromise:a.status===o?void l(a):a.status===s||a.status===x?(a.unloadPromise=a.status===x?Promise.resolve(a):f(a,"unload"),a.status=w,a.unloadPromise.then(()=>{l(a)}).catch(c=>{throw a.status=C,b(a,c)})):void 0}async function n(a){if(a.status!==t)throw b(a,new Error(`Cannot update: Not mounted: ${a.name}`));return a.status=u,f(a,"update").then(()=>{a.status=t}).catch(c=>{throw a.status=A,b(a,c)})}const o="NOT_LOADED",p="LOADING_SOURCE_CODE",q="NOT_BOOTSTRAPPED",r="BOOTSTRAPPING",s="NOT_MOUNTED",t="MOUNTED",u="UPDATING",v="UNMOUNTING",w="UNLOADING",x="LOAD_ERROR",y="BOOTSTRAPP_ERROR",z="MOUNT_ERROR",A="UPDAT_ERROR",B="UNMOUNT_ERROR",C="UNLOAD_ERROR",D="SKIP_BECAUSE_BROKEN",E=(a,b)=>{const c=/(\/\/# sourceURL=)((https?:\/\/)?([\w-])+\.{1}([a-zA-Z]{2,63})([/\w-]*)*\/?\??([^#\n\r]*)?)/;return c.test(a)?a=a.replace(c,(a,c,d)=>`${c}${URL(d,b).href}`):a+=`\n//# sourceURL=${b}`,a},F=(a,b,c)=>{if(b)return b.evaluate(a.toString(),c);if(!c&&"string"!=typeof a)return a;c=c||{};const d=Object.keys(c),e=Object.values(c),f=`'use strict';return eval(${JSON.stringify(a)})`;return new Function(...d,f)(...e)},G=(a,b={})=>fetch(a,{credentials:"same-origin",cache:"force-cache",...b}).then(b=>{if(!b.ok)throw Error([b.status,b.statusText,a].join(", "));const c=b.headers.get("content-type");if(!c||!/^(text|application)\/(x-)?javascript(;|$)/.test(c))throw Error(c);return b.text()}),H=Symbol("data");class I{constructor(){this[H]=new Map}get(a){return this[H].get(a)}define(a,b){this[H].set(a,b)}}class J{constructor({children:a,container:b,debug:c,id:d,loader:e,name:f,parent:g,properties:h,rootPortalRegistry:i,sandbox:j,shadow:k,url:l,view:m}){Object.assign(this,{bootstrap:null,bootstrapPromise:null,container:b,debug:c,id:d,loader:e,loadPromise:null,mount:null,mountPromise:null,name:f,portalRegistry:new I,portals:[],properties:h,rootPortalRegistry:i,sandbox:j,shadow:k,status:o,timeouts:null,unload:null,unloadPromise:null,unmount:null,unmountPromise:null,update:null,url:l,view:m}),Object.defineProperties(this,{children:{get(){return Object.freeze(a())}},parent:{get(){return g()}}}),Object.seal(this)}}const K=(a,b)=>{let c=a;do if(c=c.parent,c&&c.portalRegistry.get(b))return c.portalRegistry.get(b);while(c);return a.rootPortalRegistry.get(b)},L=1e3,M={bootstrap:{millis:4e3,dieOnTimeout:!1,warningMillis:L},mount:{millis:3e3,dieOnTimeout:!1,warningMillis:L},unmount:{millis:3e3,dieOnTimeout:!1,warningMillis:L},unload:{millis:3e3,dieOnTimeout:!1,warningMillis:L},update:{millis:3e3,dieOnTimeout:!1,warningMillis:L}};let N;const O="function"==typeof window.queueMicrotask?window.queueMicrotask.bind(window):a=>(N||(N=Promise.resolve())).then(a).catch(a=>setTimeout(()=>{throw a},0)),P=Symbol("first-connect"),Q=Symbol("moveing");class R extends HTMLElement{constructor(){if(super(),"function"!=typeof this.lifecycleCallback)throw new Error("Must implement interface: lifecycleCallback")}get name(){return this.getAttribute("name")||""}set name(a){this.setAttribute("name",a)}get src(){const a=this.getAttribute("src");return null===a?"":new URL(a,this.baseURI).href}set src(a){this.setAttribute("src",a)}get text(){return this.getAttribute("text")||""}set text(a){this.setAttribute("text",a)}connectedCallback(){this.lifecycleCallback("connected"),this[P]?this[Q]&&this.lifecycleCallback("moved"):(this.lifecycleCallback("firstConnected"),this[P]=!0)}disconnectedCallback(){this[Q]=!0,this.lifecycleCallback("disconnected"),O(()=>{this.isConnected||(this[Q]=!1,this.lifecycleCallback("destroyed"))})}attributeChangedCallback(){this.lifecycleCallback("attributeChanged",...arguments)}adoptedCallback(){this.lifecycleCallback("adopted",...arguments)}}window.HTMLWebSandboxBaseInterface=R;const S=window.HTMLWebSandboxElement||R,T=new I,U=S.HTMLWebSandboxElement,V=S.SANDBOX_INSTANCE,W=Symbol("config"),X=Symbol("parser"),Y=Symbol("model"),Z=Symbol("application"),$=Symbol("resourceLoaded"),_=Symbol("attributeChangedIgnore"),aa=(a,b)=>{const c=a[W]||{};return c[b]||a[b]},ba=a=>!aa(a,"inactive"),ca=a=>a.isConnected&&(aa(a,"src")||aa(a,"application")||aa(a,"text")),da=a=>ba(a)&&ca(a),ea=(a,b,c)=>{let d=a;if("string"==typeof a){const e=a,f=()=>G(e).then(a=>{const d=c(E(a,e),b);return d});f.url=e,d=f}else"function"!=typeof a&&(d=()=>Promise.resolve(a));return(...a)=>d(...a).then(a=>("string"==typeof a&&(a=c(a,b)),a))},fa=a=>{let b=a;do if(b=b.getRootNode().host,b&&b[Y])return b;while(b);return null},ga=a=>{const b=[],c=[...a.children];for(;c.length;){const a=c.pop();a[Y]?b.push(a):c.unshift(...a.children)}return b},ha=a=>{const b=fa(a);return b?b[Y]:null},ia=a=>{const b=a[Y],c=b.shadow,d=[...ga(a),...ga(c)],e=d.map(a=>a[Y]);return e.push(...b.portals),e},ja=a=>{const b={},c=a.getAttribute("include-data");if(c){const d=c&&a.ownerDocument.getElementById(c),e=d&&d.textContent;e&&Object.assign(b,JSON.parse(e))}return Object.assign(b,a.dataset),b},ka=async a=>{da(a)&&(ba(a)?a.mount():a.unmount())},la=b=>{if(b[Y])return b[Y];if(!ca(b))throw new Error("Resources are not yet ready");let c,d;const e=aa(b,"src"),f=aa(b,"text"),g=aa(b,"application"),h=aa(b,"debug"),i=aa(b,X)||a,j=b.id,k=b.name,l=b[V],m=e||g.url,n=ja(b);if(l){const a=l.global.document,b=a.createElement("style");b.textContent=`body{margin:0}`,a.head.appendChild(b),c=l.global.document.body,d=l.toNative(l.global.document)}else c=d=b.attachShadow({mode:"closed"});const o=ea(e||g||(async()=>f),l,i);return b[Y]=new J({children:()=>ia(b),container:c,debug:h,id:j,loader:o,name:k||(g?g.name:b.localName),parent:()=>ha(b),properties:{data:n},rootPortalRegistry:T,sandbox:l,shadow:d,url:m,view:b}),b[Y]};class ma extends S{constructor(){super(),U&&(this[U]=!0)}get application(){return this[Z]||null}set application(a){this[Z]=a,ka(this)}get inactive(){return null!==this.getAttribute("inactive")}set inactive(a){return a?this.setAttribute("inactive",""):this.removeAttribute("inactive")}get importance(){return this.getAttribute("importance")||""}set importance(a){this.setAttribute("importance",a)}get loading(){return this.getAttribute("loading")||""}set loading(a){this.setAttribute("loading",a)}get sandboxed(){return null!==this.getAttribute("sandboxed")}set sandboxed(a){return a?this.setAttribute("sandboxed",""):this.removeAttribute("sandboxed")}get status(){return this[Y]?this[Y].status:"NOT_LOADED"}static get portals(){return T}async load(){la(this);const a=i(this[Y]);return this.src&&!this[$]&&(this[$]=!0,a.then(()=>{this.dispatchEvent(new Event("load"))},()=>{this.dispatchEvent(new Event("error"))})),a}async bootstrap(){await this.load(),await h(this[Y])}async mount(){await this.bootstrap(),await k(this[Y]),this[_]=!0,this.removeAttribute("inactive"),this[_]=!1}async update(a){if(!this[Y])throw new Error("Not initialized");this[Y].properties=a,await n(this[Y])}async unmount(){this[Y]&&(await j(this[Y]),this[_]=!0,this.setAttribute("inactive",""),this[_]=!1)}async unload(){this[Y]&&(await this.unmount(),await m(this[Y]))}lifecycleCallback(a,...b){let c;switch(a){case"firstConnected":if(c=ha(this),c){const a=!!c.sandbox;a&&(this.sandboxed=a)}if(this.sandboxed){if("function"!=typeof super.evaluate)throw new Error(`"window.HTMLWebSandboxElement" is required to run the sandbox`);super.lifecycleCallback(...arguments)}ka(this);break;case"destroyed":this.sandboxed&&super.lifecycleCallback(...arguments),this.unload();break;case"attributeChanged":if(this[_])break;switch(this.sandboxed&&super.lifecycleCallback(...arguments),b[0]){case"text":case"src":case"inactive":ka(this);}}}static get observedAttributes(){return["src","text","inactive"]}}return Object.assign(ma,{CONFIG:W,PARSER:X,MODEL:Y}),Object.assign(ma,{NOT_LOADED:"NOT_LOADED",LOADING_SOURCE_CODE:p,NOT_BOOTSTRAPPED:q,BOOTSTRAPPING:r,NOT_MOUNTED:s,MOUNTING:"MOUNTING",MOUNTED:t,UPDATING:u,UNMOUNTING:v,UNLOADING:w,LOAD_ERROR:x,BOOTSTRAPP_ERROR:y,MOUNT_ERROR:z,UPDAT_ERROR:A,UNMOUNT_ERROR:B,UNLOAD_ERROR:C,SKIP_BECAUSE_BROKEN:D}),window.WebWidget=ma,window.HTMLWebWidgetElement=ma,customElements.define("web-widget",ma),ma});
//# sourceMappingURL=web-widget.umd.js.map
